<?xml version="1.0" encoding="euc-kr" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
					 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mycompany.webapp.dao.RegistersDao">
<!-- 종현 -->
	<!-- Create -->

	<insert id="insertNewRegister" parameterType="register">
		insert into
		registers
		(
		register_patient_id, register_user_id,
		register_regdate,
		register_date,
		register_memo,
		register_communication, register_state)
		values
		(
		#{register_patient_id},
		#{register_user_id},
		now(), #{register_date},
		#{register_memo}, #{register_communication},
		<if test="register_state==''">
		"대기"
		</if>
		<if test="register_state!=''">
		#{register_state}		
		</if>
		)
	</insert>

	<!-- Read -->
	
	<!-- 전부 불러오기 -->
	<select id="selectAllRegisters" resultType="register">
		select register_id,
		register_patient_id, register_user_id,
		register_regdate, register_date,
		register_starttime,
		register_memo, register_communication,
		register_state
		from registers
	</select>
	
	<!-- 해달 날짜 가져오기 -->
	
	<select id="selectRegistersByDate" resultType="register">
		select r.register_id, r.register_patient_id,
		r.register_user_id,
		r.register_regdate, r.register_date,
		r.register_starttime,
		r.register_memo, r.register_communication,
		r.register_state,
		p.patient_name, p.patient_ssn, p.patient_sex,
		p.patient_tel,
		u.user_name
		from registers r, patients p, users u
		<if test='state=="" '>
		where
		str_to_date(register_date,
		'%Y-%m-%d')=str_to_date(#{register_date},
		'%Y-%m-%d')
		and
		register_patient_id=patient_id
		and
		register_user_id=user_id
		order by register_date asc
		</if> 
		<if test='state!="" '>
		where
		str_to_date(register_date,
		'%Y-%m-%d')=str_to_date(#{register_date},
		'%Y-%m-%d')
		and
		register_patient_id=patient_id
		and
		register_user_id=user_id
		and
		register_state=#{state}
		order by register_date asc
		</if>
	</select>
	
	<select id="checkRegister" parameterType="register" resultType="int">
		select count(*) from registers 
		where register_date=#{register_date} 
		and register_user_id=#{register_user_id}
	</select>

	<!-- Update -->
	
	<update id="updateRegister" parameterType="register">
		update registers
		set
		register_user_id=#{register_user_id},
		register_date=#{register_date},
		register_memo=#{register_memo},
		register_communication=#{register_communication},
		register_state=#{register_state}
		where register_id=#{register_id}
	</update>
	
	
	<update id="updateStateRegister" parameterType="register">
		update registers
		set
		register_starttime=now(),
		register_state=#{register_state}
		where register_id=#{register_id}
	</update>
	<!-- Delete -->
</mapper>